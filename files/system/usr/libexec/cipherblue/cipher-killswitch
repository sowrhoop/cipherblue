#!/usr/bin/env bash
set -euo pipefail

# Simple VPN killswitch using nftables. Drops all outbound traffic unless it
# uses one of the allowed interfaces. Loopback is always allowed.
#
# Configurable via /etc/cipherblue/killswitch.conf with:
#   ALLOWED_IFACES="wg0 tun0 tap0"

ALLOWED_IFACES=${ALLOWED_IFACES:-"wg0 tun0 tap0"}


readarray -t ifaces < <(printf '%s\n' $ALLOWED_IFACES)

ruleset() {
  printf 'table inet cipher_ks {\n'
  printf '  set allowed_ifaces { type ifname; flags constant; elements = { lo'
  for i in "${ifaces[@]}"; do printf ', %s' "$i"; done
  printf ' } }\n'
  printf '  chain output { type filter hook output priority 0; policy drop;\n'
  printf '    oifname @allowed_ifaces accept;\n'
  printf '  }\n'
  printf '}\n'
}

apply() {
  nft -f <(ruleset)
}

flush() {
  nft list table inet cipher_ks >/dev/null 2>&1 && nft delete table inet cipher_ks || true
}

case "${1:-apply}" in
  apply) apply ;;
  flush) flush ;;
  *) echo "Usage: $0 [apply|flush]" >&2; exit 2 ;;
esac
